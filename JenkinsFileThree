node {
    // Set environment variables if needed
     def VENV_DIR = "${WORKSPACE}/.venv"
     def REPORT_DIR = "${WORKSPACE}/test-reports"

    // Checkout the code from the repository
    stage('Checkout') {
        checkout scm
    }

    // Install dependencies (if needed)
    stage('Install Dependencies') {
         
                // Create a virtual environment if it doesn't exist
                script {
                    if (!fileExists("${VENV_DIR}/bin/activate")) {
                        bat "python -m venv ${VENV_DIR}"
                        
                }
                }
        bat """
               call ${VENV_DIR}\\Scripts\\activate.bat
               pip3 install -r requirements.txt
               pip3 install pytest-xdist
               pip3 install  pytest-junitxml
               pip3 show selenium
               pip3 install pytest-html
        """
    }
    

    // Run pytest tests
    stage('Run Tests') {
        bat """
        if not exist "${REPORT_DIR}" mkdir "${REPORT_DIR}"
                        call ${VENV_DIR}\\Scripts\\activate.bat
                        pytest  --maxfail=5 --disable-warnings --html="${REPORT_DIR}\\test_report.html" --junitxml="${REPORT_DIR}\\test_report.xml"
                        dir "${REPORT_DIR}"
        """
    }

    // Archive the test results
    stage('Archive Test Results') {
        junit '**/test-*.xml' // Adjust the pattern to match your test result format
    }
}
